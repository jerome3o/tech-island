name: Setup Database Secret

# Manual trigger only - run this once to create the cloudsql-db-credentials secret
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "create-secret" to confirm'
        required: true
        type: string

jobs:
  create-secret:
    name: Create Database Secret in Kubernetes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "create-secret" ]; then
            echo "âŒ Confirmation failed. Please type 'create-secret' exactly."
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_CLUSTER_LOCATION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Get Database Credentials from Terraform
        id: db-creds
        working-directory: infrastructure/terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          # Initialize Terraform with backend (uses GCS bucket for state)
          # The service account already has access to the bucket
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state"

          # Get outputs without exposing to logs
          DB_IP=$(terraform output -raw database_private_ip 2>/dev/null || echo "")
          DB_NAME=$(terraform output -raw database_name 2>/dev/null || echo "")
          DB_USER=$(terraform output -raw database_user 2>/dev/null || echo "")
          DB_PASS=$(terraform output -raw database_password 2>/dev/null || echo "")

          # Validate we got the values
          if [ -z "$DB_IP" ] || [ -z "$DB_NAME" ] || [ -z "$DB_USER" ] || [ -z "$DB_PASS" ]; then
            echo "âŒ Failed to get database credentials from Terraform"
            echo "This might mean Terraform state is not accessible or Cloud SQL is not enabled"
            exit 1
          fi

          # Construct connection string (never echo this!)
          DB_URL="postgresql://${DB_USER}:${DB_PASS}@${DB_IP}:5432/${DB_NAME}"

          # Pass to next step via GitHub Actions output (masked)
          echo "::add-mask::${DB_PASS}"
          echo "::add-mask::${DB_URL}"
          echo "db_url=${DB_URL}" >> $GITHUB_OUTPUT

          echo "âœ… Database credentials retrieved successfully"
          echo "   Database: ${DB_NAME}"
          echo "   User: ${DB_USER}"
          echo "   IP: ${DB_IP}"

      - name: Create Kubernetes Secret
        run: |
          # Create namespace if it doesn't exist
          kubectl create namespace apps --dry-run=client -o yaml | kubectl apply -f -

          # Delete existing secret if present (idempotent)
          kubectl delete secret cloudsql-db-credentials -n apps --ignore-not-found=true

          # Create the secret (connection string is masked in logs)
          kubectl create secret generic cloudsql-db-credentials \
            --from-literal=url="${{ steps.db-creds.outputs.db_url }}" \
            --namespace apps

          echo "âœ… Secret 'cloudsql-db-credentials' created successfully in namespace 'apps'"

      - name: Verify Secret
        run: |
          # Verify secret exists (don't show contents)
          if kubectl get secret cloudsql-db-credentials -n apps &>/dev/null; then
            echo "âœ… Secret verified - exists in cluster"
            echo ""
            echo "Secret details:"
            kubectl describe secret cloudsql-db-credentials -n apps
          else
            echo "âŒ Secret verification failed"
            exit 1
          fi

      - name: Summary
        run: |
          echo "ğŸ‰ Database secret setup complete!"
          echo ""
          echo "âœ… Secret 'cloudsql-db-credentials' is now available in the 'apps' namespace"
          echo "âœ… Applications can reference it in their deployments"
          echo ""
          echo "Next steps:"
          echo "1. Merge your feature branch to main"
          echo "2. user-service will deploy automatically"
          echo "3. Service will be available at: https://user-service.34.142.82.161.nip.io"
