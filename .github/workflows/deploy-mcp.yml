name: Deploy MCP Servers

on:
  push:
    branches:
      - main
    paths:
      - 'mcp-servers/**'
  workflow_dispatch:
    inputs:
      server:
        description: 'MCP server to deploy (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - hello-mcp

jobs:
  detect-changes:
    name: Detect Changed MCP Servers
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.detect.outputs.servers }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed servers
        id: detect
        run: |
          # Helper function to check if a directory is a valid MCP server
          is_mcp_server() {
            [ -f "mcp-servers/$1/wrangler.jsonc" ] || [ -f "mcp-servers/$1/wrangler.json" ] || [ -f "mcp-servers/$1/wrangler.toml" ]
          }

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.server }}" == "all" ]; then
              # Get all MCP server directories (those with wrangler config)
              SERVERS=$(ls -d mcp-servers/*/ 2>/dev/null | while read dir; do
                name=$(basename "$dir")
                if is_mcp_server "$name"; then
                  echo "$name"
                fi
              done | jq -R -s -c 'split("\n") | map(select(length > 0))')
            else
              SERVERS='["${{ inputs.server }}"]'
            fi
          else
            # Get changed MCP servers from git diff, filtering to only valid server directories
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- mcp-servers/ | cut -d'/' -f2 | sort -u | while read name; do
              if [ -n "$name" ] && is_mcp_server "$name"; then
                echo "$name"
              fi
            done)
            if [ -z "$CHANGED" ]; then
              SERVERS='[]'
            else
              SERVERS=$(echo "$CHANGED" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            fi
          fi
          echo "servers=$SERVERS" >> $GITHUB_OUTPUT
          echo "Detected servers: $SERVERS"

  deploy:
    name: Deploy ${{ matrix.server }}
    needs: detect-changes
    if: needs.detect-changes.outputs.servers != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        server: ${{ fromJson(needs.detect-changes.outputs.servers) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: mcp-servers/${{ matrix.server }}
        run: npm install

      - name: Set Cloudflare secrets
        working-directory: mcp-servers/${{ matrix.server }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          AUTHORIZED_EMAIL: ${{ secrets.MCP_AUTHORIZED_EMAIL }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_MCP_SERVICE_ACCOUNT_KEY }}
        run: |
          # Set AUTHORIZED_EMAIL secret if provided
          if [ ! -z "$AUTHORIZED_EMAIL" ]; then
            echo "$AUTHORIZED_EMAIL" | npx wrangler secret put AUTHORIZED_EMAIL
          fi

          # Set GCP service account key if provided
          if [ ! -z "$GCP_SERVICE_ACCOUNT_KEY" ]; then
            echo "$GCP_SERVICE_ACCOUNT_KEY" | npx wrangler secret put GCP_SERVICE_ACCOUNT_KEY
          fi

      - name: Deploy to Cloudflare Workers
        working-directory: mcp-servers/${{ matrix.server }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx wrangler deploy

          echo ""
          echo "========================================"
          echo "  MCP Server Deployed!"
          echo "========================================"
          echo ""
          echo "Server: ${{ matrix.server }}"
          echo "URL: https://${{ matrix.server }}.${CLOUDFLARE_ACCOUNT_ID}.workers.dev/sse"
          echo ""
          echo "To connect in Claude:"
          echo "  Settings > Connectors > Add the URL above"
          echo ""
